parameters:
- name:     checkout
  type:     stepList
  default:  []
- name:     presteps
  type:     stepList
  default:  []
- name:     poststeps
  type:     stepList
  default:  []

- name:     packArtifactName
  type:     string
  default:  $(System.TeamProject)-nuget

- name:     restore
  type:     object
  default:  {}
  # skip:               true
  # displayNameSuffix:  ''
  # condition:          ''
  # projects:           ''
  # arguments:          ''
- name:     build
  type:     object
  default:  {}
  # skip:               true
  # displayNameSuffix:  ''
  # condition:          ''
  # projects:           ''
  # arguments:          ''
- name:     pack
  type:     object
  default:  {}
  # skip:               true
  # displayNameSuffix:  ''
  # condition:          ''
  # projects:           ''
  # arguments:          ''

steps:
- ${{ each step in parameters.checkout }}:
  - ${{ step }}
- ${{ each step in parameters.presteps }}:
  - ${{ step }}
- ${{ if not(parameters.restore.skip) }}:
  - task: XamarinAndroid@1
    displayName:  XamarinAndroid Restore ${{ parameters.restore.displayNameSuffix }}
    ${{ if ne('', parameters.restore.condition) }}:
      condition:    and(ne(variables['SkipBuildTasks'], 'true'), ${{ parameters.restore.condition }})
    ${{ if eq('', parameters.restore.condition) }}:
      condition:    ne(variables['SkipBuildTasks'], 'true')
    inputs:
      projectFile:      ${{ parameters.restore.projects }}
      target:           ${{ coalesce(parameters.restore.target, 'Restore') }}
      createAppPackage: false
      msbuildArguments: ${{ parameters.restore.arguments }}
      ${{ each pair in parameters.restore }}:
        ${{ if notIn(pair.key, 'projects', 'projectFile', 'target', 'createAppPackage', 'arguments', 'msbuildArguments', 'displayNameSuffix', 'condition', 'skip') }}:
          ${{ pair.key }}: ${{ pair.value }}
- ${{ if not(parameters.build.skip) }}:
  - task: XamarinAndroid@1
    displayName:  XamarinAndroid Build ${{ parameters.build.displayNameSuffix }}
    ${{ if ne('', parameters.build.condition) }}:
      condition:    and(ne(variables['SkipBuildTasks'], 'true'), ${{ parameters.build.condition }})
    ${{ if eq('', parameters.build.condition) }}:
      condition:    ne(variables['SkipBuildTasks'], 'true')
    inputs:
      projectFile:      ${{ parameters.build.projects }}
      target:           ${{ coalesce(parameters.build.target, 'Build') }}
      createAppPackage: false
      msbuildArguments: ${{ parameters.build.arguments }}
      ${{ each pair in parameters.build }}:
        ${{ if notIn(pair.key, 'projects', 'projectFile', 'target', 'createAppPackage', 'arguments', 'msbuildArguments', 'displayNameSuffix', 'condition', 'skip') }}:
          ${{ pair.key }}: ${{ pair.value }}
#- ${{ if not(parameters.test.skip) }}:
- ${{ if not(parameters.pack.skip) }}:
  - task: XamarinAndroid@1
    displayName:  XamarinAndroid Package ${{ parameters.pack.displayNameSuffix }}
    ${{ if ne('', parameters.pack.condition) }}:
      condition:  ${{ parameters.pack.condition }}
    inputs:
      projectFile:      ${{ parameters.pack.projects }}
      target:           ${{ coalesce(parameters.pack.target, 'Package') }}
      createAppPackage: true
      outputDirectory:  '$(Build.ArtifactStagingDirectory)/${{ parameters.packArtifactName }}'
      msbuildArguments: ${{ parameters.pack.arguments }}
      ${{ each pair in parameters.pack }}:
        ${{ if notIn(pair.key, 'projects', 'projectFile', 'target', 'createAppPackage', 'outputDirectory', 'arguments', 'msbuildArguments', 'displayNameSuffix', 'condition', 'skip') }}:
          ${{ pair.key }}: ${{ pair.value }}
  - task: PublishBuildArtifacts@1
    ${{ if ne('', parameters.pack.condition) }}:
      condition:      ${{ parameters.pack.condition }}
    displayName:      Upload Package artifacts
    inputs:
      pathtoPublish:  '$(Build.ArtifactStagingDirectory)/${{ parameters.packArtifactName }}'
      artifactName:   ${{ coalesce(parameters.packArtifactName, '$(System.TeamProject)-nuget') }}
    continueOnError:  true
- ${{ each step in parameters.poststeps }}:
  - ${{ step }}
